// src/workers/sig-verification.ts
import { schnorr } from "@noble/curves/secp256k1";
import { sha256 } from "@noble/hashes/sha256";
globalThis.onmessage = (msg) => {
  const { serialized, id, sig, pubkey } = msg.data;
  queueMicrotask(() => {
    const eventHash = sha256(new TextEncoder().encode(serialized));
    const idHash = hexToBytes(id);
    if (!compareTypedArrays(eventHash, idHash)) {
      postMessage([id, false]);
      return;
    }
    const result = schnorr.verify(sig, idHash, pubkey);
    postMessage([id, result]);
  });
};
function hexToBytes(hex) {
  const bytes = new Uint8Array(hex.length / 2);
  for (let i = 0; i < bytes.length; i++) {
    bytes[i] = parseInt(hex.substr(i * 2, 2), 16);
  }
  return bytes;
}
function compareTypedArrays(arr1, arr2) {
  if (arr1.length !== arr2.length) {
    return false;
  }
  for (let i = 0; i < arr1.length; i++) {
    if (arr1[i] !== arr2[i]) {
      return false;
    }
  }
  return true;
}
